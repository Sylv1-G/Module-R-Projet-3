---
title: "Aménagement : phase d'analyse"
output: html_document
date: '2023-03-26'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = F, warning = F)

#### Répertoire de travail relatif à la source du fichier ####
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

```{r librairies, include=F}
librarian::shelf(tidyverse,sf,readxl,stars,terra,gstat,automap,xtable,patchwork,gridExtra,ggthemes,tmap)
```


## Création du parcellaire cadastral
IL faut récupérer les extraits de matrices cadastrales par commune et par propriétaire. Cela permet de fabriquer un fichier excel contenant l'ensemble des parcelles cadastrales.
Le cadastre géoréférencé par commune peut être téléchargé à l'adresse
https://cadastre.data.gouv.fr/datasets/cadastre-etalab
Il faut ensuite procéder à la fusion des deux infos

```{r, cache=TRUE, echo=T}
# lecture du fichier Excel
Listecad <- read_excel("Foncier/CadastreNew.xlsx", sheet="Data") %>% 
  mutate(Id = paste(INSEE, section, numero, sep="-")) %>% 
  dplyr::select(Id, Amgt)

listeCom <- read_excel("Foncier/CadastreNew.xlsx", sheet="Communes") %>% 
  mutate(Dept = str_sub(INSEE, start = 1L, end = 2L))
ListeDep <- unique(listeCom$Dept)

parcCad78077 <- st_read("Foncier/cadastre-78077-parcelles.json", quiet=T)
parcCad78407 <- st_read("Foncier/cadastre-78407-parcelles.json", quiet=T)
parcCad78606 <- st_read("Foncier/cadastre-78606-parcelles.json", quiet=T)

parcCadProp <- rbind(parcCad78077, parcCad78407, parcCad78606) %>% 
  dplyr::select(commune, section, numero, contenance) %>% 
  mutate(Id = paste(commune, section, numero, sep="-")) %>% 
  left_join(Listecad, by = "Id") %>% 
  filter(!is.na(Amgt))

parcCad <- parcCadProp %>% 
  filter(Amgt == "Forêt")

rm(parcCad78077, parcCad78407, parcCad78606)

# st_write(parcCad, "Cadastre.gpkg")
```



```{r, ech}
par(mar=c(0,0,0,0))
plot(st_geometry(parcCad), col='grey90')
plot(parcCadProp["Amgt"])

st_write(parcCadProp, "Parcelle_propriete.gpkg")

```

```{r}
perim <- parcCad %>% 
  group_by() %>% 
  summarise() %>% 
  st_sf() %>% 
  mutate(Prop = "Tremblaye") %>% 
  st_transform(2154)

perim_wgs84 <- perim %>% 
  st_transform(4326)
```


# Milieux

## Géologie
```{r}
geol <- st_read("/Users/maxbruciamacchie/pCloudSync/EnCours/PSG2023/SIG/Vecteurs/Milieu/GEO050K_HARM_IDF_S_FGEOL_2154.shp") %>% 
  st_crop(perim)

geolProp <- geol %>% 
  st_intersection(perim)

ggplot() +
  geom_sf(data=geol, aes(fill=factor(CODE))) +
  geom_sf(data=perim, fill=NA, color='orange')
```


## Stations

## Climat
```{r, ETP, cache=T}
mois = c("04","05","06","07","08","09")
Adresse = "https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V2/GLOBAL/climatologies/1981-2010/pet/CHELSA_pet_penman_"
ETP <- data.frame()
for(i in 1:length(mois)) {
  MoisTour = paste0(Adresse,mois[i],"_1981-2010_V.2.1.tif")
  etpTour <- rast(MoisTour) %>% 
    crop(perim_wgs84)
  
  clim <-  etpTour %>% 
    st_as_stars() %>% 
    st_as_sf() %>% 
    st_transform(2154) %>% 
    mutate(Mois = mois[i]) %>% 
    rename(etp = values)
  
  ETP = rbind(ETP, clim)
  
  print(i)
}

tm_shape(ETP) +
  tm_polygons("etp") +
  tm_facets(by = "Mois") +
tm_shape(perim) +
  tm_borders(col='blue')
  
```


# Desserte
```{r}
# st_layers("/Users/maxbruciamacchie/Downloads/yvelines-latest.osm.pbf")
desserte <- st_read("/Users/maxbruciamacchie/Downloads/yvelines-latest.osm.pbf", layer="lines") %>% 
  st_transform(2154) %>% 
  st_crop(perim)

plot(st_geometry(desserte))
st_write(desserte, "Desserte.gpkg")
```

